# JMM

volatile 是 java 虚拟机提供轻量级的同步机制

1. 保证可见性
2. 不保证原子性
    - 原子性：不可分割。 线程 A 在执行任务的时候，不能被打扰，也不能被分割。要么同时成功，要么同时失败。
3. 禁止指令重排

什么是指令重排？ 源代码-》编译器优化的重排-》指令并行也可能会重排-》内存系统也会重排-》执行

```
int x = 1;
int y = 2;
x = x+5;
y = x * x;

所期望的：1234
2134，1324也能跑
不可能是4123
```

volatile 可以避免指令重排：

内存屏障，cpu 指令，作用：

1. 保证特定的操作的执行顺序。
2. 可以保证某些变量的内存可见性 （利用这些特性 volatile 实现了可见性）。

如果不加 lock 和 synchronized，如何保证原子性？

使用原子类。

什么是 jmm？

jmm java 内存模型，不存在的东西，是个概念/约定。

关于 jmm 的一些同步的约定：

1. 线程解锁时，必须把共享变量立刻刷回主存。
2. 线程加锁前，必须读取主存中的最新值到工作内存中。
3. 加锁和解锁是统一把锁。

内存交互操作有8种：

- lock
- unlock
- read
- load
- use
- assign
- store
- write